<UserControl x:Class="VCenterMigrationTool.Views.Pages.Settings.PowerShellSettingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:helpers="clr-namespace:VCenterMigrationTool.Helpers"
             xmlns:viewmodels="clr-namespace:VCenterMigrationTool.ViewModels.Settings"
             mc:Ignorable="d" 
             d:DataContext="{d:DesignInstance Type=viewmodels:PowerShellSettingsViewModel, IsDesignTimeCreatable=False}">
    <UserControl.Resources>
        <helpers:InverseBooleanConverter x:Key="InverseBooleanConverter" />
        <helpers:BoolToStringConverter x:Key="BoolToStringConverter"/>
        <helpers:BoolToSymbolConverter x:Key="BoolToSymbolConverter"/>
        <helpers:BoolToColorConverter x:Key="BoolToColorConverter"/>
        <helpers:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    </UserControl.Resources>
    <StackPanel>
        <TextBlock FontSize="20" FontWeight="Medium" Text="Prerequisites" />
        <TextBlock Margin="0,12,0,12" Foreground="{DynamicResource TextFillColorSecondaryBrush}" Text="Check for required software and modules." />

        <!-- PowerShell Version Info -->
        <Grid Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <TextBlock Grid.Column="0" Text="PowerShell Version:" FontWeight="Medium" VerticalAlignment="Center"/>
            <TextBlock Grid.Column="1" Text="{Binding PowerShellVersion}" Margin="10,0,0,0" VerticalAlignment="Center" Height="38" TextWrapping="Wrap"/>
        </Grid>

        <!-- Overall Module Status -->
        <Grid Margin="0,0,0,15">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <TextBlock Grid.Column="0" Text="Overall Status:" FontWeight="Medium" VerticalAlignment="Center"/>
            <TextBlock Grid.Column="1" Text="{Binding OverallModuleStatus}" Margin="10,0,0,0" VerticalAlignment="Center" TextWrapping="Wrap"/>
        </Grid>

        <!-- Required Modules Collection -->
        <TextBlock Text="Required Modules:" FontWeight="Medium" Margin="0,10,0,10"/>
        <ItemsControl ItemsSource="{Binding RequiredModules}" Margin="0,0,0,15">
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <ui:Card Margin="0,0,0,10" Padding="15">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- Module Icon -->
                            <ui:SymbolIcon Grid.Column="0" Grid.RowSpan="3" 
                                           Symbol="{Binding IsInstalled, Converter={StaticResource BoolToSymbolConverter}}" 
                                           Foreground="{Binding IsInstalled, Converter={StaticResource BoolToColorConverter}}" 
                                           VerticalAlignment="Center" Margin="0,0,15,0" FontSize="24"/>

                            <!-- Module Name -->
                            <TextBlock Grid.Column="1" Grid.Row="0" Text="{Binding Name}" FontWeight="SemiBold" FontSize="14"/>

                            <!-- Module Description -->
                            <TextBlock Grid.Column="1" Grid.Row="1" Text="{Binding Description}" 
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}" FontSize="12" TextWrapping="Wrap"/>

                            <!-- Module Status and Version -->
                            <StackPanel Grid.Column="1" Grid.Row="2" Orientation="Horizontal" Margin="0,5,0,0">
                                <TextBlock Text="Status: " FontWeight="Medium" FontSize="11"/>
                                <TextBlock Text="{Binding Status}" FontSize="11" Margin="0,0,10,0"/>
                                <TextBlock Text="Version: " FontWeight="Medium" FontSize="11"/>
                                <TextBlock Text="{Binding InstalledVersion}" FontSize="11"/>
                            </StackPanel>

                            <!-- Required Badge -->
                            <Border Grid.Column="2" Grid.RowSpan="3" Background="{DynamicResource SystemAccentColorLight2}" 
                                    CornerRadius="10" Padding="8,4" VerticalAlignment="Center" Margin="10,0,10,0"
                                    Visibility="{Binding IsRequired, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock Text="Required" FontSize="10" Foreground="White" FontWeight="Medium"/>
                            </Border>

                            <!-- Install Button (only for PowerCLI) -->
                            <ui:Button Grid.Column="3" Grid.RowSpan="3" Content="Install" FontSize="11" Padding="8,4"
                                       Command="{Binding DataContext.InstallPowerCliCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                       VerticalAlignment="Center">
                                <ui:Button.Style>
                                    <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding Name}" Value="VMware.PowerCLI"/>
                                                    <Condition Binding="{Binding IsInstalled}" Value="False"/>
                                                    <Condition Binding="{Binding DataContext.IsInstallingPowerCli, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="False"/>
                                                </MultiDataTrigger.Conditions>
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </MultiDataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ui:Button.Style>
                            </ui:Button>
                        </Grid>
                    </ui:Card>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- Status Messages -->
        <TextBlock Text="{Binding PrerequisiteCheckStatus}" Foreground="{DynamicResource TextFillColorSecondaryBrush}" TextWrapping="Wrap" Margin="0,0,0,10"/>
        <TextBlock Text="{Binding PowerCliInstallStatus}" Foreground="{DynamicResource TextFillColorSecondaryBrush}" TextWrapping="Wrap" Margin="0,0,0,10"/>

        <!-- Progress Bars -->
        <ProgressBar IsIndeterminate="True" Height="6" Margin="0,0,0,10" Visibility="{Binding IsCheckingPrerequisites, Converter={StaticResource BooleanToVisibilityConverter}}" />

        <!-- NEW: PowerCLI Installation Progress -->
        <!-- ENHANCED: PowerCLI Installation Progress Card -->
        <ui:Card Visibility="{Binding IsInstallingPowerCli, Converter={StaticResource BooleanToVisibilityConverter}}" 
         Margin="0,0,0,15" 
         Padding="20">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Header with Progress Ring -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,15">
                    <ui:ProgressRing Width="32" Height="32" IsIndeterminate="True" Margin="0,0,15,0"/>
                    <StackPanel>
                        <TextBlock Text="Installing PowerCLI" FontWeight="SemiBold" FontSize="16"/>
                        <TextBlock Text="Please wait while we download and install the VMware PowerCLI module" 
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}" 
                           FontSize="12"/>
                    </StackPanel>
                </StackPanel>

                <!-- Current Status -->
                <TextBlock Grid.Row="1" 
                   Text="{Binding PowerCliInstallStatus}" 
                   Margin="0,0,0,10" 
                   TextWrapping="Wrap"
                   FontWeight="Medium"/>

                <!-- Progress Bar -->
                <ProgressBar Grid.Row="2" 
                     IsIndeterminate="True" 
                     Height="6" 
                     Margin="0,0,0,15"/>

                <!-- Installation Info -->
                <StackPanel Grid.Row="3">
                    <TextBlock Text="⏱️ Expected time: 3-5 minutes" 
                       FontSize="12" 
                       Foreground="{DynamicResource TextFillColorSecondaryBrush}" 
                       Margin="0,0,0,5"/>
                    <TextBlock Text="📦 Downloading: VMware.PowerCLI (~150MB)" 
                       FontSize="12" 
                       Foreground="{DynamicResource TextFillColorSecondaryBrush}" 
                       Margin="0,0,0,5"/>
                    <TextBlock Text="🔗 Source: PowerShell Gallery" 
                       FontSize="12" 
                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                </StackPanel>
            </Grid>
        </ui:Card>
        <!-- Action Buttons -->
        <StackPanel Orientation="Horizontal" Margin="0,0,0,20">
            <ui:Button Content="Check Prerequisites" 
                       Icon="{ui:SymbolIcon DocumentSearch24}" 
                       Command="{Binding CheckPrerequisitesCommand}" 
                       IsEnabled="{Binding IsCheckingPrerequisites, Converter={StaticResource InverseBooleanConverter}}" />

            <ui:Button Content="Install PowerCLI" 
                       Icon="{ui:SymbolIcon ArrowDownload24}" 
                       Margin="10,0,0,0" 
                       Command="{Binding InstallPowerCliCommand}" 
                       IsEnabled="{Binding IsInstallingPowerCli, Converter={StaticResource InverseBooleanConverter}}" 
                       Visibility="{Binding IsPowerCliInstalled, Converter={StaticResource InverseBooleanToVisibilityConverter}}">

                <!-- NEW: Button Content Template for Progress State -->
                <ui:Button.Style>
                    <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsInstallingPowerCli}" Value="True">
                                <Setter Property="Content" Value="Installing..."/>
                                <Setter Property="Icon" Value="{ui:SymbolIcon ArrowClockwise24}"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ui:Button.Style>
            </ui:Button>
            <TextBlock Text="{Binding DebugBypassStatus}" 
                       Foreground="Orange" 
                       FontWeight="Bold" 
                       Margin="0,10,0,0"/>
        </StackPanel>

        <!-- Success Message -->
        <ui:InfoBar Title="Prerequisites Ready!" 
                    Message="{Binding OverallModuleStatus}" 
                    Severity="Success" 
                    IsOpen="{Binding IsPowerCliInstalled}" 
                    Margin="0,0,0,20" />

        <!-- NEW: Installation Progress InfoBar -->
        <ui:InfoBar Title="Installing PowerCLI" 
                    Message="Downloading and installing VMware PowerCLI module. This process may take several minutes depending on your internet connection." 
                    Severity="Informational" 
                    IsOpen="{Binding IsInstallingPowerCli}" 
                    Margin="0,0,0,20" />
    </StackPanel>
</UserControl>