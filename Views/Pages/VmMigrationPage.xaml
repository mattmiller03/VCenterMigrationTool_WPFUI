<Page
    x:Class="VCenterMigrationTool.Views.Pages.VmMigrationPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:viewmodels="clr-namespace:VCenterMigrationTool.ViewModels"
    xmlns:helpers="clr-namespace:VCenterMigrationTool.Helpers"
    mc:Ignorable="d"
    d:DataContext="{d:DesignInstance viewmodels:VmMigrationViewModel, IsDesignTimeCreatable=False}"
    Title="VmMigrationPage"
    ui:Design.Background="{DynamicResource ApplicationBackgroundBrush}"
    ui:Design.Foreground="{DynamicResource TextFillColorPrimaryBrush}">

    <Page.Resources>
        <helpers:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <helpers:InverseBooleanConverter x:Key="InverseBooleanConverter" />
        <helpers:BoolToParameterConverter x:Key="BoolToParameterConverter" />
        <helpers:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter" />
        <helpers:BoolToColorConverter x:Key="BoolToColorConverter" />
        <helpers:BoolToAppearanceConverter x:Key="BoolToAppearanceConverter" />
    </Page.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto" 
                  HorizontalScrollBarVisibility="Disabled"
                  PanningMode="VerticalOnly"
                  CanContentScroll="True">

        <Grid Margin="42" helpers:ScrollBehavior.FixMouseWheel="True">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Page Title -->
            <TextBlock Grid.Row="0" 
                      FontSize="24" 
                      FontWeight="Medium" 
                      Text="Virtual Machine Migration" 
                      Margin="0,0,0,20" />

            <!-- Refresh Data Button -->
            <ui:CardControl Grid.Row="1" Margin="0,0,0,20">
                <Grid>
                    <ui:Button Content="Refresh Data" 
                               Command="{Binding RefreshDataCommand}"
                               Icon="{ui:SymbolIcon ArrowClockwise24}"
                               Appearance="Secondary"
                               HorizontalAlignment="Right"/>
                </Grid>
            </ui:CardControl>

            <!-- Load Data Section -->
            <ui:CardControl Grid.Row="2" Margin="0,0,0,20">
                <StackPanel>
                    <TextBlock Text="Data Loading" FontWeight="Medium" FontSize="16" />
                    <TextBlock Margin="0,5,0,15" 
                              Text="Load source VMs and target vCenter resources" 
                              Foreground="{DynamicResource TextFillColorSecondaryBrush}" />

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="10" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <ui:Button Content="Load Source VMs" 
                                      Command="{Binding LoadSourceVMsCommand}"
                                      Icon="{ui:SymbolIcon Desktop24}"
                                      IsEnabled="{Binding IsLoadingData, Converter={StaticResource InverseBooleanConverter}}"
                                      Appearance="Primary"
                                      Margin="0,0,0,10" />

                            <ui:Button Content="Select All VMs" 
                                      Command="{Binding SelectAllVMsCommand}"
                                      Icon="{ui:SymbolIcon CheckboxChecked24}"
                                      IsEnabled="{Binding IsLoadingData, Converter={StaticResource InverseBooleanConverter}}"
                                      Margin="0,0,0,5" />

                            <ui:Button Content="Unselect All VMs" 
                                      Command="{Binding UnselectAllVMsCommand}"
                                      Icon="{ui:SymbolIcon CheckboxUnchecked24}"
                                      IsEnabled="{Binding IsLoadingData, Converter={StaticResource InverseBooleanConverter}}" />
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <ui:Button Content="Load Target Resources" 
                                      Command="{Binding LoadTargetResourcesCommand}"
                                      Icon="{ui:SymbolIcon Server24}"
                                      IsEnabled="{Binding IsLoadingData, Converter={StaticResource InverseBooleanConverter}}"
                                      Appearance="Primary"
                                      Margin="0,0,0,10" />

                            <TextBlock Text="Target Cluster" Margin="0,0,0,5" />
                            <ComboBox ItemsSource="{Binding TargetClusters}" 
                                     SelectedItem="{Binding SelectedTargetCluster}"
                                     DisplayMemberPath="Name"
                                     IsEnabled="{Binding IsLoadingData, Converter={StaticResource InverseBooleanConverter}}" />
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </ui:CardControl>

            <!-- VM List Section -->
            <ui:CardControl Grid.Row="3" Margin="0,0,0,20">
                <StackPanel>
                    <TextBlock Text="Source Virtual Machines" FontWeight="Medium" FontSize="16" />
                    <TextBlock Margin="0,5,0,15" 
                              Text="Select VMs to migrate or backup" 
                              Foreground="{DynamicResource TextFillColorSecondaryBrush}" />

                    <DataGrid ItemsSource="{Binding SourceVms}"
                             AutoGenerateColumns="False"
                             CanUserAddRows="False"
                             CanUserDeleteRows="False"
                             SelectionMode="Extended"
                             GridLinesVisibility="Horizontal"
                             HeadersVisibility="Column"
                             MaxHeight="300">
                        <DataGrid.Columns>
                            <DataGridCheckBoxColumn Header="Select" 
                                                   Binding="{Binding IsSelected, UpdateSourceTrigger=PropertyChanged}"
                                                   Width="60" />
                            <DataGridTextColumn Header="VM Name" 
                                               Binding="{Binding Name}" 
                                               Width="200" />
                            <DataGridTextColumn Header="Power State" 
                                               Binding="{Binding PowerState}" 
                                               Width="100" />
                            <DataGridTextColumn Header="ESXi Host" 
                                               Binding="{Binding EsxiHost}" 
                                               Width="150" />
                            <DataGridTextColumn Header="Datastore" 
                                               Binding="{Binding Datastore}" 
                                               Width="150" />
                            <DataGridTextColumn Header="Cluster" 
                                               Binding="{Binding Cluster}" 
                                               Width="*" />
                        </DataGrid.Columns>
                    </DataGrid>
                </StackPanel>
            </ui:CardControl>

            <!-- VM Configuration Backup Section -->
            <ui:CardControl Grid.Row="4" Margin="0,0,0,20">
                <StackPanel>
                    <TextBlock Text="VM Configuration Backup" FontWeight="Medium" FontSize="16" />
                    <TextBlock Margin="0,5,0,15" 
                              Text="Backup virtual machine configurations for disaster recovery and compliance" 
                              Foreground="{DynamicResource TextFillColorSecondaryBrush}" />

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="10" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- Left Column - Backup Configuration -->
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Backup Scope" FontWeight="Medium" Margin="0,0,0,8" />

                            <RadioButton Content="Selected VMs (checked in VM list)" 
                                       IsChecked="{Binding BackupSelectedVMs}"
                                       Margin="0,0,0,5" />

                            <RadioButton Content="All VMs in selected cluster" 
                                       IsChecked="{Binding BackupAllVMsInCluster}"
                                       IsEnabled="{Binding SelectedTargetCluster, Converter={StaticResource BoolToParameterConverter}}"
                                       Margin="0,0,0,5" />

                            <RadioButton Content="All VMs in vCenter" 
                                       IsChecked="{Binding BackupAllVMsInVCenter}"
                                       Margin="0,0,0,15" />

                            <TextBlock Text="Backup Options" FontWeight="Medium" Margin="0,0,0,8" />

                            <CheckBox Content="VM settings and configuration" 
                                     IsChecked="{Binding IncludeVMSettings}"
                                     Margin="0,0,0,3" />

                            <CheckBox Content="VM annotations and notes" 
                                     IsChecked="{Binding IncludeVMAnnotations}"
                                     Margin="0,0,0,3" />

                            <CheckBox Content="Custom attributes" 
                                     IsChecked="{Binding IncludeVMCustomAttributes}"
                                     Margin="0,0,0,3" />

                            <CheckBox Content="Snapshot information" 
                                     IsChecked="{Binding IncludeVMSnapshots}"
                                     Margin="0,0,0,3" />

                            <CheckBox Content="VM permissions (if accessible)" 
                                     IsChecked="{Binding IncludeVMPermissions}"
                                     Margin="0,0,0,3" />

                            <CheckBox Content="Compress backup file" 
                                     IsChecked="{Binding CompressBackup}"
                                     Margin="0,0,0,15" />

                            <TextBlock Text="Backup Location" FontWeight="Medium" Margin="0,0,0,5" />
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <ui:TextBox Grid.Column="0" 
                                           Text="{Binding BackupLocation}" 
                                           PlaceholderText="Select backup folder location"
                                           Margin="0,0,5,0" />

                                <ui:Button Grid.Column="1" 
                                          Content="Browse" 
                                          Command="{Binding BrowseBackupLocationCommand}"
                                          Icon="{ui:SymbolIcon Folder24}" />
                            </Grid>
                        </StackPanel>

                        <!-- Right Column - Backup Actions and Status -->
                        <StackPanel Grid.Column="2">
                            <TextBlock Text="Backup Actions" FontWeight="Medium" Margin="0,0,0,8" />

                            <ui:Button Content="Backup VM Configurations" 
                                      Command="{Binding BackupVMConfigurationsCommand}"
                                      Icon="{ui:SymbolIcon Save24}"
                                      IsEnabled="{Binding IsBackupInProgress, Converter={StaticResource InverseBooleanConverter}}"
                                      Appearance="Primary"
                                      Margin="0,0,0,8" />

                            <ui:Button Content="Validate Existing Backups" 
                                      Command="{Binding ValidateBackupCommand}"
                                      Icon="{ui:SymbolIcon CheckmarkCircle24}"
                                      IsEnabled="{Binding IsBackupInProgress, Converter={StaticResource InverseBooleanConverter}}"
                                      Margin="0,0,0,8" />

                            <ui:Button Content="Restore Configuration..." 
                                      Command="{Binding RestoreVMConfigurationCommand}"
                                      Icon="{ui:SymbolIcon ArrowUndo24}"
                                      IsEnabled="{Binding IsBackupInProgress, Converter={StaticResource InverseBooleanConverter}}"
                                      Margin="0,0,0,15" />

                            <!-- Backup Status -->
                            <TextBlock Text="Backup Status" FontWeight="Medium" Margin="0,0,0,8" />

                            <Grid Visibility="{Binding IsBackupInProgress, Converter={StaticResource BoolToVisibilityConverter}}"
                                  Margin="0,0,0,10">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <ProgressBar Grid.Row="0" 
                                            Value="{Binding BackupProgress}" 
                                            Maximum="100"
                                            Height="6"
                                            Margin="0,0,0,5" />

                                <TextBlock Grid.Row="1" 
                                          Text="{Binding BackupProgress, StringFormat='{}{0:F0}%'}" 
                                          HorizontalAlignment="Center"
                                          FontSize="12"
                                          Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                            </Grid>

                            <TextBlock Text="{Binding BackupStatus}" 
                                      Margin="0,0,0,10"
                                      TextWrapping="Wrap" />

                            <!-- Backup Results -->
                            <TextBlock Text="Recent Activity" 
                                      FontWeight="Medium" 
                                      Margin="0,5,0,5"
                                      Visibility="{Binding BackupResults.Count, Converter={StaticResource BoolToParameterConverter}}" />

                            <ScrollViewer MaxHeight="120" 
                                         VerticalScrollBarVisibility="Auto"
                                         Visibility="{Binding BackupResults.Count, Converter={StaticResource BoolToParameterConverter}}">
                                <ItemsControl ItemsSource="{Binding BackupResults}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding}" 
                                                      FontSize="11"
                                                      Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                      TextWrapping="Wrap"
                                                      Margin="0,1" />
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>

                            <!-- Backup Progress Ring -->
                            <ui:ProgressRing IsIndeterminate="True"
                                            Visibility="{Binding IsBackupInProgress, Converter={StaticResource BoolToVisibilityConverter}}"
                                            Width="32" Height="32"
                                            Margin="0,10,0,0"
                                            HorizontalAlignment="Center" />
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </ui:CardControl>

            <!-- Migration Configuration Section -->
            <ui:CardControl Grid.Row="5" Margin="0,0,0,20">
                <StackPanel>
                    <TextBlock Text="Migration Configuration" FontWeight="Medium" FontSize="16" />
                    <TextBlock Margin="0,5,0,15" 
                              Text="Configure VM migration options and network mapping" 
                              Foreground="{DynamicResource TextFillColorSecondaryBrush}" />

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="10" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- Left Column - Migration Options -->
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Migration Options" FontWeight="Medium" Margin="0,0,0,8" />

                            <TextBlock Text="VM Name Suffix" Margin="0,0,0,3" />
                            <ui:TextBox Text="{Binding NameSuffix}" 
                                       PlaceholderText="e.g., -Imported"
                                       Margin="0,0,0,10" />

                            <TextBlock Text="Disk Format" Margin="0,0,0,3" />
                            <ComboBox ItemsSource="{Binding AvailableDiskFormats}" 
                                     SelectedItem="{Binding SelectedDiskFormat}"
                                     Margin="0,0,0,10" />

                            <TextBlock Text="Max Concurrent Migrations" Margin="0,0,0,3" />
                            <ui:NumberBox Value="{Binding MaxConcurrentMigrations}" 
                                         Minimum="1" 
                                         Maximum="10"
                                         Margin="0,0,0,10" />

                            <CheckBox Content="Preserve MAC addresses" 
                                     IsChecked="{Binding PreserveMAC}"
                                     Margin="0,5,0,5" />

                            <CheckBox Content="Sequential mode (one at a time)" 
                                     IsChecked="{Binding SequentialMode}"
                                     Margin="0,0,0,5" />

                            <CheckBox Content="Enhanced network handling" 
                                     IsChecked="{Binding EnhancedNetworkHandling}"
                                     Margin="0,0,0,5" />

                            <CheckBox Content="Ignore network errors" 
                                     IsChecked="{Binding IgnoreNetworkErrors}"
                                     Margin="0,0,0,5" />

                            <CheckBox Content="Validation only (no migration)" 
                                     IsChecked="{Binding ValidateOnly}"
                                     Margin="0,0,0,5" />
                        </StackPanel>

                        <!-- Right Column - Network Mapping -->
                        <StackPanel Grid.Column="2">
                            <TextBlock Text="Network Mapping" FontWeight="Medium" Margin="0,0,0,8" />

                            <ui:Button Content="Add Network Mapping" 
                                      Command="{Binding AddNetworkMappingCommand}"
                                      Icon="{ui:SymbolIcon Add24}"
                                      Margin="0,0,0,10" />

                            <ScrollViewer MaxHeight="200" VerticalScrollBarVisibility="Auto">
                                <ItemsControl ItemsSource="{Binding NetworkMappings}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="0,0,0,5">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="30" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>

                                                <ui:TextBox Grid.Column="0"
                                                           Text="{Binding SourceNetwork}"
                                                           PlaceholderText="Source Network" />

                                                <TextBlock Grid.Column="1" 
                                                          Text="→" 
                                                          HorizontalAlignment="Center"
                                                          VerticalAlignment="Center" />

                                                <ui:TextBox Grid.Column="2"
                                                           Text="{Binding TargetNetwork}"
                                                           PlaceholderText="Target Network" />

                                                <ui:Button Grid.Column="3"
                                                          Content="×"
                                                          Command="{Binding DataContext.RemoveNetworkMappingCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                                          CommandParameter="{Binding}"
                                                          Width="30"
                                                          Margin="5,0,0,0" />
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </ui:CardControl>

            <!-- Migration Actions Section -->
            <ui:CardControl Grid.Row="6" Margin="0,0,0,20">
                <StackPanel>
                    <TextBlock Text="Migration Actions" FontWeight="Medium" FontSize="16" />
                    <TextBlock Margin="0,5,0,15" 
                              Text="Execute VM migrations and post-migration tasks" 
                              Foreground="{DynamicResource TextFillColorSecondaryBrush}" />

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="10" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- Left Column - Migration Actions -->
                        <StackPanel Grid.Column="0">
                            <ui:Button Content="Validate Migration" 
                                      Command="{Binding ValidateMigrationCommand}"
                                      Icon="{ui:SymbolIcon CheckmarkCircle24}"
                                      IsEnabled="{Binding IsMigrating, Converter={StaticResource InverseBooleanConverter}}"
                                      Margin="0,0,0,10" />

                            <ui:Button Content="Start VM Migration" 
                                      Command="{Binding StartVMMigrationCommand}"
                                      Icon="{ui:SymbolIcon Play24}"
                                      IsEnabled="{Binding IsMigrating, Converter={StaticResource InverseBooleanConverter}}"
                                      Appearance="Primary"
                                      Margin="0,0,0,10" />

                            <ui:Button Content="Run Post-Migration Cleanup" 
                                      Command="{Binding RunPostMigrationCleanupCommand}"
                                      Icon="{ui:SymbolIcon Broom24}"
                                      IsEnabled="{Binding IsLoadingData, Converter={StaticResource InverseBooleanConverter}}"
                                      Margin="0,0,0,10" />
                        </StackPanel>

                        <!-- Right Column - Migration Status -->
                        <StackPanel Grid.Column="2">
                            <TextBlock Text="Migration Status" FontWeight="Medium" Margin="0,0,0,8" />

                            <Grid Visibility="{Binding IsMigrating, Converter={StaticResource BoolToVisibilityConverter}}"
                                  Margin="0,0,0,10">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <ProgressBar Grid.Row="0" 
                                            Value="{Binding MigrationProgress}" 
                                            Maximum="100"
                                            Height="6"
                                            Margin="0,0,0,5" />

                                <TextBlock Grid.Row="1" 
                                          Text="{Binding MigrationProgress, StringFormat='{}{0:F0}%'}" 
                                          HorizontalAlignment="Center"
                                          FontSize="12"
                                          Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                            </Grid>

                            <TextBlock Text="{Binding MigrationStatus}" 
                                      Margin="0,0,0,10"
                                      TextWrapping="Wrap" />

                            <ui:ProgressRing IsIndeterminate="True"
                                            Visibility="{Binding IsMigrating, Converter={StaticResource BoolToVisibilityConverter}}"
                                            Width="32" Height="32"
                                            HorizontalAlignment="Center" />
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </ui:CardControl>

            <!-- Activity Log Terminal Panel - Dashboard Style -->
            <ui:CardControl Grid.Row="7">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="200"/>
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <Border Grid.Row="0" 
                           Background="{DynamicResource CardStrokeColorDefaultBrush}"
                           Padding="20,12">
                        <Grid>
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="WindowConsole20" Margin="0,0,10,0"/>
                                <TextBlock Text="Activity Log" 
                                          FontWeight="SemiBold"
                                          VerticalAlignment="Center"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <ui:Button Content="Clear" 
                                          Command="{Binding ClearLogCommand}"
                                          Appearance="Secondary"
                                          Padding="8,4"
                                          FontSize="12"
                                          Margin="0,0,8,0"/>
                                <ui:Button Content="Auto Scroll" 
                                          Command="{Binding ToggleAutoScrollCommand}"
                                          Appearance="{Binding IsAutoScrollEnabled, Converter={StaticResource BoolToAppearanceConverter}}"
                                          Padding="8,4"
                                          FontSize="12"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Terminal Content -->
                    <Border Grid.Row="1" 
                           Background="#1E1E1E"
                           BorderBrush="#404040"
                           BorderThickness="1,0,1,1">
                        <ScrollViewer x:Name="LogScrollViewer"
                                     VerticalScrollBarVisibility="Auto"
                                     HorizontalScrollBarVisibility="Auto"
                                     Padding="12">
                            <TextBlock x:Name="LogTextBlock"
                                      Text="{Binding ActivityLog}"
                                      FontFamily="Consolas, Courier New"
                                      FontSize="12"
                                      Foreground="#00FF00"
                                      Background="Transparent"
                                      TextWrapping="NoWrap"/>
                        </ScrollViewer>
                    </Border>
                </Grid>
            </ui:CardControl>
        </Grid>
    </ScrollViewer>
</Page>